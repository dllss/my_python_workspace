# Python 股票数据分析项目

使用多数据源（baostock、akshare、yfinance）获取 A 股股票数据的 Python 项目。

## 目录

- [快速开始](#快速开始)
- [每日数据更新](#每日数据更新)
- [项目结构](#项目结构)
- [配置说明](#配置说明)
- [脚本使用说明](#脚本使用说明)
- [项目特性](#项目特性)
  - [股票名称变化追踪](#股票名称变化追踪)
- [数据格式规范](#数据格式规范)
- [日志系统](#日志系统)
- [性能优化](#性能优化)
- [更新日志](#更新日志)

---

## 快速开始

### 1. 安装依赖

本项目使用 [Poetry](https://python-poetry.org/) 管理依赖。

```bash
# 安装 Poetry（如果未安装）
pip install poetry

# 安装项目依赖
poetry install

# 检查数据源是否可用（可选，推荐）
make check-sources
```

### 2. 首次使用流程

```bash
# 步骤1：获取股票列表
make list

# 步骤2：批量获取历史数据（需要2-3小时）
make history

# 步骤3：重建元数据（可选，提高性能）
make rebuild-metadata
```

### 3. 日常更新（推荐）

```bash
# 每天 18:30 之后运行（推荐 19:00+）
# 使用批量接口，5-10秒内完成所有股票更新
make daily
```

---

## 每日数据更新

### 🚀 三种更新方式对比

#### 方式1：TuShare 批量接口（最推荐）⭐⭐⭐⭐⭐

**命令**：
```bash
make daily-tushare
```

**特点**：
- ✅ **速度极快**：5-10秒完成（vs 2-3小时）
- ✅ **一次请求**：批量获取所有5000只股票数据
- ✅ **网络稳定**：无需访问东方财富，无代理问题
- ✅ **数据质量高**：官方维护，长期稳定
- ✅ **适合定时任务**：可设置 cron 每天自动运行

**要求**：
- ⚠️ 需要注册 TuShare 账号（免费）
- ⚠️ 需要至少 120 积分（注册填写信息即可获得）

**配置步骤**：
1. 注册账号：https://tushare.pro/register
2. 获取 Token：https://tushare.pro/user/token
3. 配置 Token：`export TUSHARE_TOKEN="你的token"`
4. 安装依赖：`make install-tushare`
5. 运行：`make daily-tushare`

**详细文档**：见 [TUSHARE_SETUP.md](TUSHARE_SETUP.md)

---

#### 方式2：AkShare 批量接口 ⭐⭐⭐

**命令**：
```bash
make daily
```

**特点**：
- ✅ **速度极快**：5-10秒完成（vs 2-3小时）
- ✅ **一次请求**：批量获取所有5000只股票数据
- ✅ **无需注册**：完全免费，无需账号
- ⚠️ **网络要求**：需要访问东方财富（可能遇到代理问题）

**原理**：
使用 AkShare 的 `stock_zh_a_spot_em()` 批量接口，一次性获取所有股票的当日数据。

**注意**：
- 如果遇到 `ProxyError` 或网络问题，建议使用方式1（TuShare）或方式3（BaoStock）
- 详见 [NETWORK_ISSUES.md](NETWORK_ISSUES.md)

---

#### 方式3：BaoStock 逐个轮询（最稳定）⭐⭐⭐⭐

**命令**：
```bash
make history
```

**特点**：
- ✅ **多数据源**：baostock → akshare → yfinance 自动切换
- ✅ **稳定可靠**：无网络限制，适合获取历史数据
- ✅ **无需注册**：完全免费，无需账号
- ⚠️ **速度较慢**：5000只股票需要2小时

**适用场景**：
- 首次获取历史数据
- 补充缺失数据
- 数据修复
- 网络环境受限时的备用方案

---

### 📊 方式对比总结

| 方式 | 命令 | 速度 | 网络要求 | 注册要求 | 推荐度 |
|-----|------|------|---------|---------|--------|
| **TuShare** | `make daily-tushare` | 5-10秒 | 无特殊要求 | 需要（免费） | ⭐⭐⭐⭐⭐ |
| **AkShare** | `make daily` | 5-10秒 | 需访问东方财富 | 不需要 | ⭐⭐⭐ |
| **BaoStock** | `make history` | 2小时 | 无特殊要求 | 不需要 | ⭐⭐⭐⭐ |

**建议**：
- 日常使用：优先使用 `make daily-tushare`（最快最稳定）
- 备用方案：如果没有 TuShare 账号，使用 `make history`（慢但稳定）
- 不推荐：`make daily`（AkShare）容易遇到网络问题

---

### ⏰ 最佳运行时间

**推荐时间**：19:00 之后

**原因**：
- BaoStock 在 18:00 完成数据更新
- AkShare 数据源也在收盘后更新
- 留30分钟缓冲时间确保数据完整

**时间检查机制**：
- **18:30 之前**：自动调整为获取昨天的数据
- **18:30 之后**：正常获取今天的数据

---

### 🔄 设置定时任务（推荐）

#### Linux/Mac (cron)

```bash
# 编辑 crontab
crontab -e

# 添加定时任务（每天 19:00 运行）
0 19 * * 1-5 cd /path/to/my_python_workspace && make daily >> logs/daily.log 2>&1
```

**说明**：
- `0 19 * * 1-5`：每周一到周五 19:00 运行
- 自动跳过周末和节假日（脚本内置交易日检查）

#### Windows (任务计划程序)

1. 打开"任务计划程序"
2. 创建基本任务
3. 触发器：每天 19:00
4. 操作：运行程序
   - 程序：`cmd.exe`
   - 参数：`/c cd /d "C:\path\to\my_python_workspace" && make daily`

---

### 📊 性能对比

| 方式 | 时间 | 接口请求次数 | 资源消耗 | 适用场景 |
|------|------|-------------|---------|---------|
| `run-daily` | **5-10秒** | **1次** | 低 | ✅ 日常更新 |
| `run-all-v2` | **2-3小时** | **5000次** | 高 | ✅ 历史数据 |

---

## 项目结构

```
.
├── config.py                   # 配置文件（股票代码、日期范围等）
├── utils/                      # 工具函数模块
│   ├── __init__.py
│   ├── trading_day_checker.py  # 交易日检查
│   ├── market_status_checker.py # 市场状态检查（18:30时间限制）
│   ├── missing_date_range_checker.py # 缺失日期范围检查
│   ├── metadata_manager.py     # 元数据管理（性能优化）
│   └── data_saver.py           # 数据保存工具
├── fetchers/                   # 数据获取器模块
│   ├── __init__.py
│   ├── akshare_fetcher.py      # Akshare 数据获取器
│   ├── baostock_fetcher.py     # Baostock 数据获取器
│   ├── yfinance_fetcher.py     # YFinance 数据获取器
│   └── multi_source_fetcher.py # 多数据源管理器（推荐）
├── fetch_stock_list.py         # 获取 A 股全部股票列表
├── fetch_single_stock.py       # 获取单只股票历史数据
├── fetch_historical_data.py    # 批量获取所有 A 股历史数据（多数据源，推荐）
├── fetch_daily_data.py         # 批量获取当日数据（高效版，推荐）
├── scripts/                    # 辅助脚本目录
│   ├── check_trading_day.py   # 交易日查询工具
│   ├── check_data_sources.py  # 数据源可用性检查
│   ├── rebuild_metadata.py    # 重建元数据文件
│   ├── example_usage.py       # 使用示例
│   └── test_*.py              # 各种测试脚本
├── data/                       # 数据存储目录
│   └── CN/                     # A 股数据目录
│       ├── stock_list.csv      # 股票列表
│       ├── stock_*.csv         # 各股票历史数据
│       └── .metadata.json      # 元数据文件（性能优化）
├── pyproject.toml              # Poetry 配置文件
├── poetry.lock                 # 依赖锁定文件
├── Makefile                    # Make 命令配置
└── README.md                   # 项目说明（本文件）
```

---

## 配置说明

### 全局配置 (`config.py`)

```python
# 文件路径配置
OUTPUT_DIR = "data"                 # 数据输出目录
CN_DIR = "CN"                       # 中国A股数据子目录

# 股票数据配置
STOCK_CODE = "600519"               # 默认股票代码（贵州茅台）
START_DATE = "20000101"             # 开始日期
END_DATE = (datetime.now() - timedelta(days=1)).strftime("%Y%m%d")  # 结束日期（昨天）
ADJUST_TYPE = "qfq"                 # 复权类型: qfq(前复权), hfq(后复权), ""(不复权)

# 批量获取配置
DELAY_MIN = 2                       # 最小延迟（秒）
DELAY_MAX = 4                       # 最大延迟（秒）
BATCH_SIZE = 10                     # 每批处理的股票数量（0表示处理全部）
START_INDEX = 0                     # 从第几只股票开始（0表示从头开始）
UPDATE_MODE = "tail"                # 更新模式: tail(只补充尾部), full(完全刷新), head_tail(补充头尾)

# 数据源配置
PREFERRED_SOURCE = "baostock"       # 优先数据源: baostock(默认), akshare, yfinance
```

### 更新模式说明

| 模式 | 行为 | 适用场景 |
|------|------|---------|
| **tail** | 只补充尾部数据，忽略中间缺失 | 日常增量更新（推荐，避免停牌重试） |
| **full** | 完全刷新，补充所有缺失数据 | 初次获取或数据修复 |
| **head_tail** | 补充头尾，忽略中间缺失 | 扩展历史数据范围 |

**说明**：中间缺失通常是因为**个股停牌**，而非数据丢失。默认 `tail` 模式会忽略中间缺失，避免对停牌日发起无效的 API 请求。

### 数据源配置

本项目支持三个数据源，并可配置优先级：

| 数据源 | 特点 | 适用场景 |
|--------|------|---------|
| **baostock** | 数据最完整，质量高（默认） | 历史数据获取、数据修复 |
| **akshare** | 速度快，但可能被限流 | 快速查询、实时数据 |
| **yfinance** | 国际数据源，A股支持有限 | 备用数据源 |

**配置方式**：

1. **全局配置**（`config.py`）：
   ```python
   PREFERRED_SOURCE = "baostock"  # 修改为 akshare 或 yfinance
   ```

2. **命令行参数**（`fetch_single_stock.py`）：
   ```bash
   python fetch_single_stock.py 000001 --source akshare
   ```

**工作机制**：
- 优先使用配置的数据源
- 如果失败，自动切换到其他数据源
- 确保数据获取的稳定性和可靠性

---

## 脚本使用说明

### Makefile 命令（推荐）

```bash
# 数据获取
make list            # 获取A股股票列表
make single CODE=000001  # 获取单只股票数据
make history         # 批量获取历史数据（多数据源）
make daily           # 批量获取当日数据（高效版，推荐日常使用）

# 工具命令
make check-date DATE=20260211  # 查询指定日期是否为交易日
make check-sources   # 检查数据源可用性
make rebuild-metadata # 重建元数据文件
make analyze-names   # 分析股票名称变化历史
make clean-suspended # 检查停牌数据（只检测）
make clean-suspended CLEAN=1  # 清理停牌数据（执行清理）
make analyze-names CODE=000004  # 分析指定股票的名称变化

# 维护命令
make install         # 安装依赖
make update          # 更新所有依赖（包括交易日历）
make clean           # 清理 Python 缓存
```

### 所有可用脚本

| 脚本 | 功能 | Makefile命令 | 直接运行 |
|------|------|-------------|---------|
| `fetch_stock_list.py` | 获取A股股票列表 | `make list` | `poetry run python fetch_stock_list.py` |
| `fetch_single_stock.py` | 获取单只股票数据 | `make single CODE=000001` | `python fetch_single_stock.py 000001` |
| `fetch_historical_data.py` | 批量获取历史数据 | `make history` | `poetry run python fetch_historical_data.py` |
| `fetch_daily_data.py` | 批量获取当日数据 | `make daily` | `poetry run python fetch_daily_data.py` |
| `scripts/check_trading_day.py` | 查询交易日 | `make check-date DATE=20000103` | `poetry run python scripts/check_trading_day.py 20000103` |
| `scripts/check_data_sources.py` | 检查数据源 | `make check-sources` | `poetry run python scripts/check_data_sources.py` |
| `scripts/rebuild_metadata.py` | 重建元数据 | `make rebuild-metadata` | `poetry run python scripts/rebuild_metadata.py` |
| `scripts/clean_suspended_data.py` | 清理停牌数据 | `make clean-suspended CLEAN=1` | `poetry run python scripts/clean_suspended_data.py --clean` |

### 获取单只股票数据

快速获取单只股票的历史数据（全量替换模式）：

```bash
# 使用 Makefile（推荐）
make single CODE=000001                              # 获取全部历史数据
make single CODE=600519 START=20240101 END=20240131  # 指定日期范围

# 直接运行
python fetch_single_stock.py 000001                  # 获取全部历史数据
python fetch_single_stock.py 600519 --start 20240101 --end 20240131
python fetch_single_stock.py 000001 --output my_data.csv  # 自定义输出路径
python fetch_single_stock.py 000001 --source akshare     # 指定优先数据源
python fetch_single_stock.py                         # 交互式输入
```

**特点**：
- ✅ 全量替换模式（不做增量更新，直接覆盖）
- ✅ 自动更新元数据（确保与其他脚本的兼容性）
- ✅ 自动过滤停牌数据
- ✅ 支持多数据源自动切换
- ✅ 可配置优先数据源（`--source`）
- ✅ 自动获取股票名称
- ✅ 支持自定义日期范围
- ✅ 支持交互式输入
- ✅ 显示数据预览和统计信息

---

### 数据源可用性检查

检查 baostock、akshare、yfinance 三个数据源的连接状态：

```bash
make check-sources
```

输出示例：
```
数据源可用性检查
============================================================
正在检查数据源...

检查结果:
------------------------------------------------------------
✅ Baostock（优先）: 可用
✅ Akshare: 可用
❌ YFinance（备用）: 不可用

============================================================
总结: 2/3 个数据源可用
⚠️  注意: 部分数据源不可用，但仍可正常获取数据
============================================================
```

### 交易日查询工具

快速查询指定日期是否为 A 股交易日：

```bash
# 使用 Makefile
make check-date DATE=20260211

# 直接运行
python check_trading_day.py 20260211
python check_trading_day.py 2026-02-11
python check_trading_day.py 2026/02/11
```

支持的日期格式：
- `YYYYMMDD`（如 `20260211`）
- `YYYY-MM-DD`（如 `2026-02-11`）
- `YYYY/MM/DD`（如 `2026/02/11`）

---

### 停牌数据清理工具

检查并清理所有股票文件中的停牌数据（成交量或成交额为0/空的记录）：

```bash
# 只检测，不修改文件（推荐先运行）
make clean-suspended

# 执行清理操作
make clean-suspended CLEAN=1

# 直接运行
poetry run python scripts/clean_suspended_data.py          # 只检测
poetry run python scripts/clean_suspended_data.py --clean  # 执行清理
```

**功能说明**：
- ✅ 扫描所有股票文件，检测停牌数据
- ✅ 显示详细的清理报告
- ✅ 自动更新元数据
- ✅ 生成详细的报告文件（保存在 `data/CN/suspended_data_report_*.txt`）
- ✅ 支持只检测模式（不修改文件）

**停牌数据特征**：
- 成交量为 0 或空
- 成交额为 0 或空

**清理结果示例**：
```
================================================================================
清理报告
================================================================================
总文件数: 834
包含停牌数据的文件: 732
已清理的文件: 732
总共移除记录数: 187,599
处理出错的文件: 0
================================================================================
```

**注意事项**：
- ⚠️ 清理操作会直接修改文件，建议先运行检测模式
- ⚠️ 清理后会自动更新元数据，确保数据一致性
- ⚠️ 新获取的数据会自动过滤停牌数据，通常不需要手动清理

---

## 每日数据更新

### 推荐工作流程

#### 第一次使用（获取历史数据）

```bash
# 1. 获取股票列表
make list

# 2. 获取所有历史数据（需要较长时间）
make history

# 3. 重建元数据（可选，提高性能）
make rebuild-metadata
```

#### 日常使用（每天更新）

```bash
# 每天 18:30 之后运行（推荐 19:00+）
make daily
```

**说明**：
- ✅ 几秒内完成
- ✅ 自动更新所有股票的当日数据
- ✅ 自动更新元数据

**⚠️ 网络问题**：
- `make daily` 使用 **akshare** 的东方财富批量接口，可能需要代理
- 如果遇到网络错误（如 `HTTPSConnectionPool` 或 `ProxyError`），建议：
  1. 检查网络代理设置
  2. 或者使用 `make history`（使用 baostock，更稳定但较慢）

### 性能对比

| 方式 | 时间 | 接口请求次数 | 资源消耗 | 适用场景 |
|------|------|-------------|---------|---------|
| `run-daily` | **5-10秒** | **1次** | 低 | ✅ 日常更新 |
| `run-all-v2` | **2-3小时** | **5000次** | 高 | ✅ 历史数据 |

**性能提升**：约 **1000 倍**！🚀

---

## 项目特性

### 多数据源策略

- **优先级**: baostock（优先）→ akshare（备用）→ yfinance（备用）
- **自动降级**: 当主数据源失败时，自动尝试备用数据源
- **数据统一**: 所有数据源返回统一的格式

### 智能增量更新

- 自动检测已有数据，只获取缺失日期的数据
- 支持头部、尾部、中间缺失的智能识别
- **停牌智能处理**：默认模式（tail）忽略中间缺失，避免停牌导致的重复请求
- 避免重复请求，提高效率

### 智能交易日识别

- **exchange_calendars 库**：使用专业的交易所日历，准确识别A股交易日
  - 支持上海证券交易所（XSHG）完整交易日历
  - **配置范围**：2000-01-04 至 2026-12-31（支持 27 年）
  - 准确识别春节、国庆等长假期休市时间
  - 正确处理调休工作日（如春节后周日上班，股市仍休市）
- **自动降级**：
  - 2000 年之前的数据：自动降级为周末判断（周一到周五 = 交易日）
  - exchange_calendars 不可用时：降级为周末判断
- **自动跳过**：检测到日期范围全是非交易日时，自动跳过 API 请求

### 数据完整性保护

**18:30 时间检查机制**：
- 18:30 之前：自动使用昨天作为结束日期
- 18:30 之后：允许获取今日数据（BaoStock 数据已完整）
- 推荐：在 18:30 之后运行脚本以获取完整的当日数据

**停牌数据自动过滤**：
- ✅ 自动过滤成交量或成交额为空/0的停牌数据
- ✅ 在保存和合并数据时都会执行过滤
- ✅ 确保CSV文件中只包含正常交易数据
- ✅ 输出时显示过滤数量（如：`+3828 条, 过滤95条停牌`）
- 特征：成交量为空 且 成交额为空 → 判定为停牌

### 性能优化

- **元数据缓存**：使用 `.metadata.json` 记录每只股票的最新日期
- **快速跳过**：已是最新的股票，0.02秒内完成检查（vs 原来的1秒）
- **性能提升**：50,000 倍（从 1000ms 降至 0.02ms）

### 耗时统计

- **单只股票耗时**：实时显示每只股票的获取耗时
- **总体统计**：
  - 总耗时（秒/分钟）
  - 平均耗时（每只股票）
  - 最快/最慢耗时
  - 平均处理速度（只/秒）

### 股票名称变化追踪

**保留历史名称策略**：
- ✅ 不修改历史数据中的股票名称
- ✅ 新数据使用最新名称
- ✅ 可以追踪股票何时改名（如变为 ST、退市等）

**工作原理**：
```
2024-01-01: 乐视网      ← 历史数据保留
2024-01-02: 乐视网      ← 历史数据保留
2024-06-01: *ST乐视     ← 自动使用新名称
2024-06-02: *ST乐视     ← 自动使用新名称
```

**分析工具**：
```bash
# 分析所有股票的名称变化
make analyze-names

# 分析指定股票
make analyze-names CODE=000004
```

**优势**：
- 真实反映历史状态
- 可以追踪名称变化时间点
- 对数据分析和回测更有价值

---

## 数据格式规范

### 统一数据格式

所有数据源返回的数据格式完全一致：

```
['日期', '股票代码', '开盘', '收盘', '最高', '最低', '成交量', '成交额', '振幅', '涨跌幅', '涨跌额', '换手率']
```

### 数据类型

| 列名 | 数据类型 | 说明 |
|------|---------|------|
| 日期 | object (string) | 格式：'YYYY-MM-DD' |
| 股票代码 | object (string) | 6位代码，如 '000001' |
| 开盘 | float64 | 保留2位小数 |
| 收盘 | float64 | 保留2位小数 |
| 最高 | float64 | 保留2位小数 |
| 最低 | float64 | 保留2位小数 |
| 成交量 | int64 | 整数 |
| 成交额 | float64 | 保留2位小数 |
| 振幅 | float64 | 保留2位小数，单位：% |
| 涨跌幅 | float64 | 保留2位小数，单位：% |
| 涨跌额 | float64 | 保留2位小数 |
| 换手率 | float64 | 保留2位小数，单位：% |

### 数据源特性对比

| 字段 | AkShare | Baostock | YFinance | 说明 |
|------|---------|----------|----------|------|
| 日期 | ✅ | ✅ | ✅ | 统一格式 YYYY-MM-DD |
| 股票代码 | ✅ | ✅ | ✅ | 统一6位代码 |
| 开盘/收盘/最高/最低 | ✅ | ✅ | ✅ | 统一2位小数 |
| 成交量 | ✅ | ✅ | ✅ | - |
| 成交额 | ✅ | ✅ | ⚠️ 填充0 | YFinance 不提供 |
| 振幅 | ✅ | 🔧 计算 | 🔧 计算 | Baostock/YFinance 自动计算 |
| 涨跌幅 | ✅ | ✅ | 🔧 计算 | YFinance 自动计算 |
| 涨跌额 | ✅ | 🔧 计算 | 🔧 计算 | Baostock/YFinance 自动计算 |
| 换手率 | ✅ | ✅ | ⚠️ 填充0 | YFinance 不提供 |

**图例**：
- ✅ 原生支持
- 🔧 自动计算
- ⚠️ 不支持，填充默认值

### 计算公式

对于不提供某些字段的数据源，使用以下公式自动计算：

```python
# 涨跌幅 = (收盘价 - 昨日收盘价) / 昨日收盘价 × 100
涨跌幅 = ((收盘 - 收盘.shift(1)) / 收盘.shift(1) * 100).fillna(0)

# 涨跌额 = 收盘价 - 昨日收盘价
涨跌额 = (收盘 - 收盘.shift(1)).fillna(0)

# 振幅 = (最高价 - 最低价) / 昨日收盘价 × 100
振幅 = ((最高 - 最低) / 收盘.shift(1) * 100).fillna(0)
```

**注意**：第一行数据的涨跌额和振幅会填充为 0（因为没有"昨日"数据）。

---

## 日志系统

### 混合输出策略

本项目采用混合输出策略，结合 `print` 和 `logging` 模块的优势：

#### 使用 `logger` 的场景

1. **错误信息**：所有错误和异常使用 `logger.error()`
2. **警告信息**：重要提示使用 `logger.warning()`
3. **静态信息**：配置信息、统计结果等使用 `logger.info()`
4. **调试信息**：开发调试信息使用 `logger.debug()`

#### 使用 `print` 的场景

1. **实时进度显示**：需要在同一行更新的进度信息
2. **交互式输出**：需要用户实时看到的处理状态

### 为什么混合使用？

**`logging` 的优势**：
- ✅ 支持不同日志级别（DEBUG, INFO, WARNING, ERROR）
- ✅ 可以轻松重定向到文件
- ✅ 支持格式化和时间戳
- ✅ 更专业的日志管理

**`logging` 的限制**：
- ❌ 不支持 `end=""` 参数（无法在同一行更新）
- ❌ 每条日志自动换行
- ❌ 不适合实时进度条式输出

**`print` 的优势**：
- ✅ 支持 `end=""` 参数，可以在同一行输出
- ✅ 更适合实时进度显示
- ✅ 用户体验更好（进度条效果）

### 日志级别配置

在 `fetch_historical_data.py` 中修改：

```python
logging.basicConfig(
    level=logging.INFO,   # INFO: 只显示关键信息（推荐）
                          # DEBUG: 显示详细调试信息
    format='%(message)s'  # 简化格式，只显示消息
)
```

---

## 性能优化

### 元数据管理

**问题**：检查"已是最新"的股票需要读取整个CSV文件，耗时约1秒。

**解决方案**：使用 `.metadata.json` 文件记录每只股票的最新日期。

**性能提升**：
- 从 **1000ms** 降至 **0.02ms**
- 提升约 **50,000 倍**！

**使用方法**：
```bash
# 首次使用或数据变更后，重建元数据
make rebuild-metadata

# 日常使用：元数据自动维护，无需手动操作
```

### 元数据自动维护

元数据文件会在以下情况自动更新：
1. 每次成功保存股票数据时
2. 运行 `rebuild_metadata.py` 脚本时

**无需手动维护**，系统会自动保持元数据与实际数据同步。

### 性能统计

脚本会显示详细的耗时统计：

```
⏱️  耗时统计:
  总耗时: 245.67s (4.09min)
  平均耗时: 2.58s/只
  最快: 0.02s
  最慢: 8.92s
  实际获取: 95 只
  平均速度: 0.41 只/秒
```

### 性能优化建议

#### 1. 调整延迟参数

在 `config.py` 中调整延迟范围：

```python
DELAY_MIN = 2  # 最小延迟（秒）
DELAY_MAX = 4  # 最大延迟（秒）
```

**权衡**：
- ✅ 减小延迟 → 提高速度
- ⚠️ 延迟过小 → 可能触发 API 限流

#### 2. 使用批量模式

对于大量股票，使用分批处理：

```python
BATCH_SIZE = 100   # 每批处理 100 只
START_INDEX = 0    # 从第 0 只开始
```

**优势**：
- 可以随时中断和恢复
- 降低单次运行的时间压力
- 便于错误排查

#### 3. 选择合适的更新模式

```python
UPDATE_MODE = 'tail'  # 只更新尾部（最快）
```

**说明**：
- `tail` 模式：跳过中间缺失，速度最快
- `full` 模式：补全所有缺失，速度较慢
- `head_tail` 模式：补充头尾，速度中等

---

## 数据源说明

### 数据源优先级

1. **Baostock**（优先）⭐⭐⭐⭐⭐
   - 数据质量高，官方维护
   - 更新时间：当日 18:00 完成
   - 适合历史数据回测

2. **AkShare**（备用）⭐⭐⭐⭐
   - 覆盖面广，数据源多
   - 准实时数据（3-15秒延迟）
   - 适合盘后分析和日常更新

3. **YFinance**（备用）⭐⭐⭐
   - 国际接口
   - 对中国A股支持有限
   - 适合作为最后备选

### 数据更新时间

| 数据源 | 更新机制 | 当日数据可用时间 | 说明 |
|--------|---------|----------------|------|
| BaoStock | T+1 | 当日 18:00 | 日K线和复权因子完整更新 |
| AkShare | 准实时 | 收盘后即可 | 3-15秒延迟，依赖第三方网站 |
| YFinance | 实时 | 不确定 | A股支持不完整 |

**建议**：在 **18:30 之后**运行脚本，确保所有数据源都已完整更新。

---

## 常见问题

### Q: 如何修改获取的日期范围？
A: 修改 `config.py` 中的 `START_DATE` 和 `END_DATE`

### Q: 批量获取需要多长时间？
A: 
- 历史数据（`run-all-v2`）：约2-3小时（5000只股票）
- 当日数据（`run-daily`）：约5-10秒（5000只股票）

### Q: 如何分批获取？
A: 修改 `config.py` 中的：
```python
BATCH_SIZE = 100    # 每批100只
START_INDEX = 0     # 从第0只开始
```
运行后查看提示，修改 `START_INDEX` 继续下一批

### Q: 数据存储在哪里？
A: `data/CN/` 目录下：
- `stock_list.csv` - 股票列表
- `stock_{代码}.csv` - 各股票历史数据
- `failed_stocks.csv` - 失败列表（如有）
- `.metadata.json` - 元数据文件（性能优化）

### Q: 如何应对反爬机制？
A: 脚本已内置防护措施：
1. ✅ 随机延迟（2-4秒）
2. ✅ 多数据源切换
3. ✅ 详细日志记录

如果遇到频繁被封：
- 增加延迟时间（`DELAY_MIN=3`, `DELAY_MAX=6`）
- 减少批次大小（`BATCH_SIZE=5`）
- 分时段运行

### Q: 如何清理缓存？
A: `make clean`

### Q: 如何更新依赖？
A: `make update`

---

## 更新日志

### 2026-02-11 - v3.0 高效日常更新

#### 新增功能
- 🚀 **批量获取当日数据**：新增 `fetch_daily_data.py` 脚本
  - 使用 AkShare 批量接口一次性获取所有股票数据
  - 5-10秒完成（vs 2-3小时）
  - 性能提升约 1000 倍
- 🛡️ **18:30 时间检查**：自动调整结束日期，确保数据完整性
  - 18:30 之前强制使用昨天
  - 18:30 之后允许获取今天
- 🗑️ **简化代码**：移除不完整数据标记机制（已被时间检查替代）

#### 核心改进
- 📦 **模块化重构**：将辅助函数抽取到 `utils/data_saver.py`
- 🔧 **元数据优化**：移除频繁的日志打印，只在批量操作时显示
- 📝 **文档整合**：所有文档整合到 README.md

### 2026-02-11 - v2.4 性能优化

#### 新增功能
- ⚡ **元数据管理**：新增 `.metadata.json` 文件记录每只股票的最新日期
- 🚀 **快速跳过**：已是最新的股票，0.02秒内完成检查（vs 原来的1秒）
- 📊 **性能提升**：50,000 倍（从 1000ms 降至 0.02ms）
- 🔧 **重建工具**：新增 `rebuild_metadata.py` 脚本

#### 核心改进
- 📈 **两级快速路径**：
  1. 超快路径：使用元数据文件（0.02ms）
  2. 快速路径：只读取CSV最后一行（10ms）
- 🔄 **自动维护**：元数据在每次保存数据时自动更新

### 2026-02-11 - v2.3 停牌智能处理

#### 新增功能
- 🎯 **更新模式配置**：新增 `UPDATE_MODE` 参数，支持三种更新策略
  - `tail`（默认）：只补充尾部数据，忽略中间缺失（避免停牌重试）
  - `full`：完全刷新，补充所有缺失数据
  - `head_tail`：补充头尾，忽略中间缺失
- 🛑 **停牌智能识别**：默认模式自动忽略中间缺失（通常是停牌），避免无效 API 请求
- 🔧 **交易日查询工具**：新增 `check_trading_day.py` 脚本

#### 核心改进
- 📊 **减少 API 请求**：tail 模式避免对历史停牌日反复请求
- 🚀 **提升性能**：大幅减少批量获取时的无效请求

### 2026-02-11 - v2.2 专业交易日历

#### 重大更新
- 🎯 **替换为 `exchange_calendars` 库**：使用专业的交易所日历
  - 支持上海证券交易所（XSHG）完整交易日历
  - **配置范围**：2000-01-04 至 2026-12-31（支持 27 年）
  - 准确识别春节、国庆等长假期休市时间
  - 正确处理调休工作日

#### 核心改进
- 📊 **只统计交易日缺失**：增量更新时，只统计交易日的缺失
- ⏭️ **自动跳过非交易日**：检测到日期范围全是非交易日时，自动跳过
- 🔄 **自动降级策略**：2000 年之前的数据自动降级为周末判断

### 2026-02-11 - v2.1 元数据并发优化与停牌数据处理

#### 核心改进
- 🔒 **元数据并发安全**：修复并发写入时的文件冲突问题
  - 使用进程ID和随机数生成唯一临时文件名
  - 实现重试机制（最多3次，指数退避）
  - 使用 `os.replace()` 确保原子操作
- 🚀 **性能提升**：支持多进程并发更新元数据，无竞态条件
- 📊 **输出优化**：停牌数据过滤信息合并到同一行显示
  - 旧格式：两行显示（数据更新 + 过滤信息）
  - 新格式：单行显示（`+3828 条, 过滤95条停牌`）
  - 提升输出简洁性和可读性
- 🎯 **元数据更新策略全面优化**：智能区分正常无数据和接口失败
  - 元数据记录**请求的结束日期**，而非CSV文件中的最后日期
  - **正常无数据**（节假日/停牌）：✅ 更新元数据，避免重复拉取
  - **接口失败**（网络错误/限流）：❌ 不更新元数据，下次重试
  - 即使获取的数据全部被过滤（如全是停牌），也会更新元数据
  - **关键修复**：移除"已是最新"时重新读取CSV更新元数据的逻辑，避免元数据被错误覆盖
  - **全面适配**：4个核心脚本（`fetch_historical_data.py`、`fetch_daily_data.py`、`fetch_single_stock.py`、`fetch_stock_list.py`）统一应用新策略

### 2026-02-10 - v2.0 多数据源版本

#### 新增功能
- ✨ 新增 `fetch_historical_data.py` 脚本，支持多数据源自动降级
- 🔄 实现 baostock → akshare → yfinance 三级数据源策略
- 📊 统一所有数据源的输出格式
- 🧮 自动计算缺失字段
- 🏗️ 重构代码结构，将数据源逻辑抽取到独立 `fetchers/` 模块

---

## 项目依赖

- **akshare** - A 股数据获取
- **baostock** - A 股数据获取（优先数据源）
- **yfinance** - 美股/港股数据获取（备用）
- **pandas** - 数据处理
- **numpy** - 数值计算
- **matplotlib** - 数据可视化
- **exchange_calendars** - 专业交易日历

## 常用 Poetry 命令

```bash
poetry install          # 安装依赖
poetry add <包名>        # 添加新依赖
poetry run python xxx.py # 运行脚本
poetry shell            # 进入虚拟环境
poetry show             # 查看已安装的包
```

---

## 许可证

MIT License

---

## 贡献

欢迎提交 Issue 和 Pull Request！
